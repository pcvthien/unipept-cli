<%=
  Oj.dump(@result.map do |k, v|
    v.map do |p|
      if @full_lineage
        lineage = p.lineage
        ids = Lineage::ORDER.map {|o| lineage.try(o) }

        names = Lineage::ORDER.map {|s| "#{s}_name"}
        lineage_info = Hash[names.zip(lineage.to_a)]

        names = Lineage::ORDER.map {|s| "#{s}_id"}
        lineage_ids = Hash[names.zip(ids)]
      end
      res = { sequence: k,
        taxon_id: p.id,
        taxon_name: p.name,
        taxon_parent_id: p.parent_id,
        taxon_rank: p.rank,
      }
      if @full_lineage
        res.merge!(lineage_info)
        res.merge!(lineage_ids)
      else
        res
      end
    end
  end.flatten).html_safe
%>
